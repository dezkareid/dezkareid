prompt = "# Codebase Concerns Template\n\nTemplate for `.planning/codebase/CONCERNS.md` - captures known issues and areas requiring care.\n\n**Purpose:** Surface actionable warnings about the codebase. Focused on \"what to watch out for when making changes.\"\n\n---\n\n## File Template\n\n```markdown\n# Codebase Concerns\n\n**Analysis Date:** [YYYY-MM-DD]\n\n## Tech Debt\n\n**[Area/Component]:**\n- Issue: [What's the shortcut/workaround]\n- Why: [Why it was done this way]\n- Impact: [What breaks or degrades because of it]\n- Fix approach: [How to properly address it]\n\n**[Area/Component]:**\n- Issue: [What's the shortcut/workaround]\n- Why: [Why it was done this way]\n- Impact: [What breaks or degrades because of it]\n- Fix approach: [How to properly address it]\n\n## Known Bugs\n\n**[Bug description]:**\n- Symptoms: [What happens]\n- Trigger: [How to reproduce]\n- Workaround: [Temporary mitigation if any]\n- Root cause: [If known]\n- Blocked by: [If waiting on something]\n\n**[Bug description]:**\n- Symptoms: [What happens]\n- Trigger: [How to reproduce]\n- Workaround: [Temporary mitigation if any]\n- Root cause: [If known]\n\n## Security Considerations\n\n**[Area requiring security care]:**\n- Risk: [What could go wrong]\n- Current mitigation: [What's in place now]\n- Recommendations: [What should be added]\n\n**[Area requiring security care]:**\n- Risk: [What could go wrong]\n- Current mitigation: [What's in place now]\n- Recommendations: [What should be added]\n\n## Performance Bottlenecks\n\n**[Slow operation/endpoint]:**\n- Problem: [What's slow]\n- Measurement: [Actual numbers: \"500ms p95\", \"2s load time\"]\n- Cause: [Why it's slow]\n- Improvement path: [How to speed it up]\n\n**[Slow operation/endpoint]:**\n- Problem: [What's slow]\n- Measurement: [Actual numbers]\n- Cause: [Why it's slow]\n- Improvement path: [How to speed it up]\n\n## Fragile Areas\n\n**[Component/Module]:**\n- Why fragile: [What makes it break easily]\n- Common failures: [What typically goes wrong]\n- Safe modification: [How to change it without breaking]\n- Test coverage: [Is it tested? Gaps?]\n\n**[Component/Module]:**\n- Why fragile: [What makes it break easily]\n- Common failures: [What typically goes wrong]\n- Safe modification: [How to change it without breaking]\n- Test coverage: [Is it tested? Gaps?]\n\n## Scaling Limits\n\n**[Resource/System]:**\n- Current capacity: [Numbers: \"100 req/sec\", \"10k users\"]\n- Limit: [Where it breaks]\n- Symptoms at limit: [What happens]\n- Scaling path: [How to increase capacity]\n\n## Dependencies at Risk\n\n**[Package/Service]:**\n- Risk: [e.g., \"deprecated\", \"unmaintained\", \"breaking changes coming\"]\n- Impact: [What breaks if it fails]\n- Migration plan: [Alternative or upgrade path]\n\n## Missing Critical Features\n\n**[Feature gap]:**\n- Problem: [What's missing]\n- Current workaround: [How users cope]\n- Blocks: [What can't be done without it]\n- Implementation complexity: [Rough effort estimate]\n\n## Test Coverage Gaps\n\n**[Untested area]:**\n- What's not tested: [Specific functionality]\n- Risk: [What could break unnoticed]\n- Priority: [High/Medium/Low]\n- Difficulty to test: [Why it's not tested yet]\n\n---\n\n*Concerns audit: [date]*\n*Update as issues are fixed or new ones discovered*\n```\n\n<good_examples>\n```markdown\n# Codebase Concerns\n\n**Analysis Date:** 2025-01-20\n\n## Tech Debt\n\n**Database queries in React components:**\n- Issue: Direct Supabase queries in 15+ page components instead of server actions\n- Files: `app/dashboard/page.tsx`, `app/profile/page.tsx`, `app/courses/[id]/page.tsx`, `app/settings/page.tsx` (and 11 more in `app/`)\n- Why: Rapid prototyping during MVP phase\n- Impact: Can't implement RLS properly, exposes DB structure to client\n- Fix approach: Move all queries to server actions in `app/actions/`, add proper RLS policies\n\n**Manual webhook signature validation:**\n- Issue: Copy-pasted Stripe webhook verification code in 3 different endpoints\n- Files: `app/api/webhooks/stripe/route.ts`, `app/api/webhooks/checkout/route.ts`, `app/api/webhooks/subscription/route.ts`\n- Why: Each webhook added ad-hoc without abstraction\n- Impact: Easy to miss verification in new webhooks (security risk)\n- Fix approach: Create shared `lib/stripe/validate-webhook.ts` middleware\n\n## Known Bugs\n\n**Race condition in subscription updates:**\n- Symptoms: User shows as \"free\" tier for 5-10 seconds after successful payment\n- Trigger: Fast navigation after Stripe checkout redirect, before webhook processes\n- Files: `app/checkout/success/page.tsx` (redirect handler), `app/api/webhooks/stripe/route.ts` (webhook)\n- Workaround: Stripe webhook eventually updates status (self-heals)\n- Root cause: Webhook processing slower than user navigation, no optimistic UI update\n- Fix: Add polling in `app/checkout/success/page.tsx` after redirect\n\n**Inconsistent session state after logout:**\n- Symptoms: User redirected to /dashboard after logout instead of /login\n- Trigger: Logout via button in mobile nav (desktop works fine)\n- File: `components/MobileNav.tsx` (line ~45, logout handler)\n- Workaround: Manual URL navigation to /login works\n- Root cause: Mobile nav component not awaiting supabase.auth.signOut()\n- Fix: Add await to logout handler in `components/MobileNav.tsx`\n\n## Security Considerations\n\n**Admin role check client-side only:**\n- Risk: Admin dashboard pages check isAdmin from Supabase client, no server verification\n- Files: `app/admin/page.tsx`, `app/admin/users/page.tsx`, `components/AdminGuard.tsx`\n- Current mitigation: None (relying on UI hiding)\n- Recommendations: Add middleware to admin routes in `middleware.ts`, verify role server-side\n\n**Unvalidated file uploads:**\n- Risk: Users can upload any file type to avatar bucket (no size/type validation)\n- File: `components/AvatarUpload.tsx` (upload handler)\n- Current mitigation: Supabase bucket limits to 2MB (configured in dashboard)\n- Recommendations: Add file type validation (image/* only) in `lib/storage/validate.ts`\n\n## Performance Bottlenecks\n\n**/api/courses endpoint:**\n- Problem: Fetching all courses with nested lessons and authors\n- File: `app/api/courses/route.ts`\n- Measurement: 1.2s p95 response time with 50+ courses\n- Cause: N+1 query pattern (separate query per course for lessons)\n- Improvement path: Use Prisma include to eager-load lessons in `lib/db/courses.ts`, add Redis caching\n\n**Dashboard initial load:**\n- Problem: Waterfall of 5 serial API calls on mount\n- File: `app/dashboard/page.tsx`\n- Measurement: 3.5s until interactive on slow 3G\n- Cause: Each component fetches own data independently\n- Improvement path: Convert to Server Component with single parallel fetch\n\n## Fragile Areas\n\n**Authentication middleware chain:**\n- File: `middleware.ts`\n- Why fragile: 4 different middleware functions run in specific order (auth -> role -> subscription -> logging)\n- Common failures: Middleware order change breaks everything, hard to debug\n- Safe modification: Add tests before changing order, document dependencies in comments\n- Test coverage: No integration tests for middleware chain (only unit tests)\n\n**Stripe webhook event handling:**\n- File: `app/api/webhooks/stripe/route.ts`\n- Why fragile: Giant switch statement with 12 event types, shared transaction logic\n- Common failures: New event type added without handling, partial DB updates on error\n- Safe modification: Extract each event handler to `lib/stripe/handlers/*.ts`\n- Test coverage: Only 3 of 12 event types have tests\n\n## Scaling Limits\n\n**Supabase Free Tier:**\n- Current capacity: 500MB database, 1GB file storage, 2GB bandwidth/month\n- Limit: ~5000 users estimated before hitting limits\n- Symptoms at limit: 429 rate limit errors, DB writes fail\n- Scaling path: Upgrade to Pro ($25/mo) extends to 8GB DB, 100GB storage\n\n**Server-side render blocking:**\n- Current capacity: ~50 concurrent users before slowdown\n- Limit: Vercel Hobby plan (10s function timeout, 100GB-hrs/mo)\n- Symptoms at limit: 504 gateway timeouts on course pages\n- Scaling path: Upgrade to Vercel Pro ($20/mo), add edge caching\n\n## Dependencies at Risk\n\n**react-hot-toast:**\n- Risk: Unmaintained (last update 18 months ago), React 19 compatibility unknown\n- Impact: Toast notifications break, no graceful degradation\n- Migration plan: Switch to sonner (actively maintained, similar API)\n\n## Missing Critical Features\n\n**Payment failure handling:**\n- Problem: No retry mechanism or user notification when subscription payment fails\n- Current workaround: Users manually re-enter payment info (if they notice)\n- Blocks: Can't retain users with expired cards, no dunning process\n- Implementation complexity: Medium (Stripe webhooks + email flow + UI)\n\n**Course progress tracking:**\n- Problem: No persistent state for which lessons completed\n- Current workaround: Users manually track progress\n- Blocks: Can't show completion percentage, can't recommend next lesson\n- Implementation complexity: Low (add completed_lessons junction table)\n\n## Test Coverage Gaps\n\n**Payment flow end-to-end:**\n- What's not tested: Full Stripe checkout -> webhook -> subscription activation flow\n- Risk: Payment processing could break silently (has happened twice)\n- Priority: High\n- Difficulty to test: Need Stripe test fixtures and webhook simulation setup\n\n**Error boundary behavior:**\n- What's not tested: How app behaves when components throw errors\n- Risk: White screen of death for users, no error reporting\n- Priority: Medium\n- Difficulty to test: Need to intentionally trigger errors in test environment\n\n---\n\n*Concerns audit: 2025-01-20*\n*Update as issues are fixed or new ones discovered*\n```\n</good_examples>\n\n<guidelines>\n**What belongs in CONCERNS.md:**\n- Tech debt with clear impact and fix approach\n- Known bugs with reproduction steps\n- Security gaps and mitigation recommendations\n- Performance bottlenecks with measurements\n- Fragile code that breaks easily\n- Scaling limits with numbers\n- Dependencies that need attention\n- Missing features that block workflows\n- Test coverage gaps\n\n**What does NOT belong here:**\n- Opinions without evidence (\"code is messy\")\n- Complaints without solutions (\"auth sucks\")\n- Future feature ideas (that's for product planning)\n- Normal TODOs (those live in code comments)\n- Architectural decisions that are working fine\n- Minor code style issues\n\n**When filling this template:**\n- **Always include file paths** - Concerns without locations are not actionable. Use backticks: `src/file.ts`\n- Be specific with measurements (\"500ms p95\" not \"slow\")\n- Include reproduction steps for bugs\n- Suggest fix approaches, not just problems\n- Focus on actionable items\n- Prioritize by risk/impact\n- Update as issues get resolved\n- Add new concerns as discovered\n\n**Tone guidelines:**\n- Professional, not emotional (\"N+1 query pattern\" not \"terrible queries\")\n- Solution-oriented (\"Fix: add index\" not \"needs fixing\")\n- Risk-focused (\"Could expose user data\" not \"security is bad\")\n- Factual (\"3.5s load time\" not \"really slow\")\n\n**Useful for phase planning when:**\n- Deciding what to work on next\n- Estimating risk of changes\n- Understanding where to be careful\n- Prioritizing improvements\n- Onboarding new Claude contexts\n- Planning refactoring work\n\n**How this gets populated:**\nExplore agents detect these during codebase mapping. Manual additions welcome for human-discovered issues. This is living documentation, not a complaint list.\n</guidelines>\n"
